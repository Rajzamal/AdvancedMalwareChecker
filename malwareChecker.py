from __future__ import print_function
import json
import hashlib
from virus_total_apis import PublicApi as VirusTotalPublicApi
from checksumdir import dirhash
import os
import checksum

#API_KEY = 'd0ea376cfca314a97b31c3d755549d6e674d35c2650ccd7c355fcedb1a23738c'
#vt = VirusTotalPublicApi(API_KEY)
directory  = 'C:/Users/Raj/Desktop/Ransomware_Defender/'

global API_KEY_FLAG
global newHash
global meow
global newList
newHash='1'

#print(md5hash)
def hashing(arr,newHash):
    global API_KEY
    API_KEY_FLAG = 0
    for x in arr:
        beforeHashed = directory+x
        #print(beforeHashed)
        hashed = checksum.get_for_file(beforeHashed,hash_mode='md5')
        #print("MD5 hash of "+x+" is "+hashed)
        API_KEY_FLAG = API_KEY_FLAG + 1
        if(API_KEY_FLAG > 4):
            API_KEY = '5a1439bcf4ded0f93be8d9450322ab3131befd11074e1a7bd1ac5d5e7a6b764d'
            vt = VirusTotalPublicApi(API_KEY)
            #rint(API_KEY_FLAG)
            #rint(API_KEY)
            virusTotal(hashed,x,vt)
        else:
            API_KEY = 'd0ea376cfca314a97b31c3d755549d6e674d35c2650ccd7c355fcedb1a23738c'
            vt = VirusTotalPublicApi(API_KEY)
            #rint(API_KEY)
            virusTotal(hashed,x,vt)
    meow = dirhash(directory, 'md5')
    newHash = meow
    return meow
        
def virusTotal(EICAR_MD5,x,vt):
    #print(API_KEY)
    response = vt.get_file_report(EICAR_MD5)
    output = json.dumps(response, sort_keys=False, indent=4)
    meow = len(output)
    #print(output)
    result1 = output.find('positives": 0')
    #print(result1)
    result2 = output.find('The requested resource is not among the finished, queued or pending scans')
    #print(result2)
    if (result1 >= 0 or result2 >= 0):
        print(x+" is Not a Malicious file")
    else:
        print(x+ " is a Malicious file")  

def mainLike(newHash):
    while True:
        md5hash = dirhash(directory, 'md5')
        #print(newHash+" "+md5hash)
        if(md5hash != newHash):
            arr = os.listdir(directory)
            newList = []
            #hashing(arr)
            for x in arr:
                if("." in x):
                   #print(x)
                    newList.append(x)
            #print(newList)
        
            meow = hashing(newList,newHash)
            newHash = meow
            print(newHash +" this is it")

mainLike(newHash)
